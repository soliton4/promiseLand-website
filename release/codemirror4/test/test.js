//>>built
define("codemirror4/test/test",["dojo","dijit","dojox"],function(s,u,v){function m(a,b){for(var d=0,e=a.length;d<e;++d)b(a[d])}function g(a,b,d){for(var e=[],f="",h=0;h<b;++h)f+="x";for(h=0;h<d;++h)e.push(f);a.setValue(e.join("\n"))}function k(a,b){function d(a){if(3!=a.nodeType){f.test(a.className)&&e.push(a);for(var b=0,c=a.childNodes.length;b<c;++b)d(a.childNodes[b])}}if(a.getElementsByClassName)return a.getElementsByClassName(b);var e=[],f=RegExp("\\b"+b+"\\b");d(a);return e}function p(a,c,d,
e){return a.markText(b(c,0),b(d-1),{inclusiveLeft:!0,inclusiveRight:!0,collapsed:!0,clearOnEnter:e})}var b=CodeMirror.Pos;CodeMirror.defaults.rtlMoveVisually=!0;s=/MSIE [1-7]\b/.test(navigator.userAgent);u=/MSIE [1-8]\b/.test(navigator.userAgent);v=/Mac/.test(navigator.platform);var q=/PhantomJS/.test(navigator.userAgent),x=/Opera\/\./.test(navigator.userAgent),r=x&&navigator.userAgent.match(/Version\/(\d+\.\d+)/);r&&(r=Number(r));var t=x&&(!r||10>r);namespace="core_";test("core_fromTextArea",function(){var a=
document.getElementById("code");a.value="CONTENT";var b=CodeMirror.fromTextArea(a);is(!a.offsetHeight);eq(b.getValue(),"CONTENT");b.setValue("foo\nbar");eq(b.getValue(),"foo\nbar");b.save();is(/^foo\r?\nbar$/.test(a.value));b.setValue("xxx");b.toTextArea();is(a.offsetHeight);eq(a.value,"xxx")});testCM("getRange",function(a){eq(a.getLine(0),"1234");eq(a.getLine(1),"5678");eq(a.getLine(2),null);eq(a.getLine(-1),null);eq(a.getRange(b(0,0),b(0,3)),"123");eq(a.getRange(b(0,-1),b(0,200)),"1234");eq(a.getRange(b(0,
2),b(1,2)),"34\n56");eq(a.getRange(b(1,2),b(100,0)),"78")},{value:"1234\n5678"});testCM("replaceRange",function(a){eq(a.getValue(),"");a.replaceRange("foo\n",b(0,0));eq(a.getValue(),"foo\n");a.replaceRange("a\nb",b(0,1));eq(a.getValue(),"fa\nboo\n");eq(a.lineCount(),3);a.replaceRange("xyzzy",b(0,0),b(1,1));eq(a.getValue(),"xyzzyoo\n");a.replaceRange("abc",b(0,0),b(10,0));eq(a.getValue(),"abc");eq(a.lineCount(),1)});testCM("selection",function(a){a.setSelection(b(0,4),b(2,2));is(a.somethingSelected());
eq(a.getSelection(),"11\n222222\n33");eqPos(a.getCursor(!1),b(2,2));eqPos(a.getCursor(!0),b(0,4));a.setSelection(b(1,0));is(!a.somethingSelected());eq(a.getSelection(),"");eqPos(a.getCursor(!0),b(1,0));a.replaceSelection("abc","around");eq(a.getSelection(),"abc");eq(a.getValue(),"111111\nabc222222\n333333");a.replaceSelection("def","end");eq(a.getSelection(),"");eqPos(a.getCursor(!0),b(1,3));a.setCursor(b(2,1));eqPos(a.getCursor(!0),b(2,1));a.setCursor(1,2);eqPos(a.getCursor(!0),b(1,2))},{value:"111111\n222222\n333333"});
testCM("extendSelection",function(a){a.setExtending(!0);g(a,10,10);a.setSelection(b(3,5));eqPos(a.getCursor("head"),b(3,5));eqPos(a.getCursor("anchor"),b(3,5));a.setSelection(b(2,5),b(5,5));eqPos(a.getCursor("head"),b(5,5));eqPos(a.getCursor("anchor"),b(2,5));eqPos(a.getCursor("start"),b(2,5));eqPos(a.getCursor("end"),b(5,5));a.setSelection(b(5,5),b(2,5));eqPos(a.getCursor("head"),b(2,5));eqPos(a.getCursor("anchor"),b(5,5));eqPos(a.getCursor("start"),b(2,5));eqPos(a.getCursor("end"),b(5,5));a.extendSelection(b(3,
2));eqPos(a.getCursor("head"),b(3,2));eqPos(a.getCursor("anchor"),b(5,5));a.extendSelection(b(6,2));eqPos(a.getCursor("head"),b(6,2));eqPos(a.getCursor("anchor"),b(5,5));a.extendSelection(b(6,3),b(6,4));eqPos(a.getCursor("head"),b(6,4));eqPos(a.getCursor("anchor"),b(5,5));a.extendSelection(b(0,3),b(0,4));eqPos(a.getCursor("head"),b(0,3));eqPos(a.getCursor("anchor"),b(5,5));a.extendSelection(b(4,5),b(6,5));eqPos(a.getCursor("head"),b(6,5));eqPos(a.getCursor("anchor"),b(4,5));a.setExtending(!1);a.extendSelection(b(0,
3),b(0,4));eqPos(a.getCursor("head"),b(0,3));eqPos(a.getCursor("anchor"),b(0,4))});testCM("lines",function(a){eq(a.getLine(0),"111111");eq(a.getLine(1),"222222");eq(a.getLine(-1),null);a.replaceRange("",b(1,0),b(2,0));a.replaceRange("abc",b(1,0),b(1));eq(a.getValue(),"111111\nabc")},{value:"111111\n222222\n333333"});testCM("indent",function(a){a.indentLine(1);eq(a.getLine(1),"   blah();");a.setOption("indentUnit",8);a.indentLine(1);eq(a.getLine(1),"\tblah();");a.setOption("indentUnit",10);a.setOption("tabSize",
4);a.indentLine(1);eq(a.getLine(1),"\t\t  blah();")},{value:"if (x) {\nblah();\n}",indentUnit:3,indentWithTabs:!0,tabSize:8});testCM("indentByNumber",function(a){a.indentLine(0,2);eq(a.getLine(0),"  foo");a.indentLine(0,-200);eq(a.getLine(0),"foo");a.setSelection(b(0,0),b(1,2));a.indentSelection(3);eq(a.getValue(),"   foo\n   bar\nbaz")},{value:"foo\nbar\nbaz"});test("core_defaults",function(){var a={},b=CodeMirror.defaults,d;for(d in b)a[d]=b[d];b.indentUnit=5;b.value="uu";b.indentWithTabs=!0;b.tabindex=
55;var e=document.getElementById("testground"),f=CodeMirror(e);try{eq(f.getOption("indentUnit"),5),f.setOption("indentUnit",10),eq(b.indentUnit,5),eq(f.getValue(),"uu"),eq(f.getOption("indentWithTabs"),!0),eq(f.getInputField().tabIndex,55)}finally{for(d in a)b[d]=a[d];e.removeChild(f.getWrapperElement())}});testCM("lineInfo",function(a){eq(a.lineInfo(-1),null);var b=document.createElement("span"),d=a.setGutterMarker(1,"FOO",b),e=a.lineInfo(1);eq(e.text,"222222");eq(e.gutterMarkers.FOO,b);eq(e.line,
1);eq(a.lineInfo(2).gutterMarkers,null);a.setGutterMarker(d,"FOO",null);eq(a.lineInfo(1).gutterMarkers,null);a.setGutterMarker(1,"FOO",b);a.setGutterMarker(0,"FOO",b);a.clearGutter("FOO");eq(a.lineInfo(0).gutterMarkers,null);eq(a.lineInfo(1).gutterMarkers,null)},{value:"111111\n222222\n333333"});testCM("coords",function(a){a.setSize(null,100);g(a,32,200);var c=a.charCoords(b(0,0)),d=a.charCoords(b(200,30));is(c.left<d.left);is(c.top<d.top);is(c.top<c.bottom);a.scrollTo(null,100);a=a.charCoords(b(0,
0));is(c.top>a.top);eq(c.left,a.left)});testCM("coordsChar",function(a){g(a,35,70);for(var c=0;2>c;++c)for(var d=c?"local":"page",e=0;35>=e;e+=5)for(var f=0;70>f;f+=5){a.setCursor(f,e);var h=a.charCoords(b(f,e),d),h=a.coordsChar({left:h.left+1,top:h.top+1},d);eqPos(h,b(f,e))}},{lineNumbers:!0});testCM("posFromIndex",function(a){a.setValue("This function should\nconvert a zero based index\nto line and ch.");for(var b=[{index:-1,line:0,ch:0},{index:0,line:0,ch:0},{index:10,line:0,ch:10},{index:39,line:1,
ch:18},{index:55,line:2,ch:7},{index:63,line:2,ch:15},{index:64,line:2,ch:15}],d=0;d<b.length;d++){var e=b[d],f=a.posFromIndex(e.index);eq(f.line,e.line);eq(f.ch,e.ch);0<=e.index&&64>e.index&&eq(a.indexFromPos(f),e.index)}});testCM("undo",function(a){a.replaceRange("def",b(0,0),b(0));eq(a.historySize().undo,1);a.undo();eq(a.getValue(),"abc");eq(a.historySize().undo,0);eq(a.historySize().redo,1);a.redo();eq(a.getValue(),"def");eq(a.historySize().undo,1);eq(a.historySize().redo,0);a.setValue("1\n\n\n2");
a.clearHistory();eq(a.historySize().undo,0);for(var c=0;20>c;++c)a.replaceRange("a",b(0,0)),a.replaceRange("b",b(3,0));eq(a.historySize().undo,40);for(c=0;40>c;++c)a.undo();eq(a.historySize().redo,40);eq(a.getValue(),"1\n\n\n2")},{value:"abc"});testCM("undoDepth",function(a){a.replaceRange("d",b(0));a.replaceRange("e",b(0));a.replaceRange("f",b(0));a.undo();a.undo();a.undo();eq(a.getValue(),"abcd")},{value:"abc",undoDepth:4});testCM("undoDoesntClearValue",function(a){a.undo();eq(a.getValue(),"x")},
{value:"x"});testCM("undoMultiLine",function(a){a.operation(function(){a.replaceRange("x",b(0,0));a.replaceRange("y",b(1,0))});a.undo();eq(a.getValue(),"abc\ndef\nghi");a.operation(function(){a.replaceRange("y",b(1,0));a.replaceRange("x",b(0,0))});a.undo();eq(a.getValue(),"abc\ndef\nghi");a.operation(function(){a.replaceRange("y",b(2,0));a.replaceRange("x",b(1,0));a.replaceRange("z",b(2,0))});a.undo();eq(a.getValue(),"abc\ndef\nghi",3)},{value:"abc\ndef\nghi"});testCM("undoComposite",function(a){a.replaceRange("y",
b(1));a.operation(function(){a.replaceRange("x",b(0));a.replaceRange("z",b(2))});eq(a.getValue(),"ax\nby\ncz\n");a.undo();eq(a.getValue(),"a\nby\nc\n");a.undo();eq(a.getValue(),"a\nb\nc\n");a.redo();a.redo();eq(a.getValue(),"ax\nby\ncz\n")},{value:"a\nb\nc\n"});testCM("undoSelection",function(a){a.setSelection(b(0,2),b(0,4));a.replaceSelection("");a.setCursor(b(1,0));a.undo();eqPos(a.getCursor(!0),b(0,2));eqPos(a.getCursor(!1),b(0,4));a.setCursor(b(1,0));a.redo();eqPos(a.getCursor(!0),b(0,2));eqPos(a.getCursor(!1),
b(0,2))},{value:"abcdefgh\n"});testCM("undoSelectionAsBefore",function(a){a.replaceSelection("abc","around");a.undo();a.redo();eq(a.getSelection(),"abc")});testCM("markTextSingleLine",function(a){m([{a:0,b:1,c:"",f:2,t:5},{a:0,b:4,c:"",f:0,t:2},{a:1,b:2,c:"x",f:3,t:6},{a:4,b:5,c:"",f:3,t:5},{a:4,b:5,c:"xx",f:3,t:7},{a:2,b:5,c:"",f:2,t:3},{a:2,b:5,c:"abcd",f:6,t:7},{a:2,b:6,c:"x",f:null,t:null},{a:3,b:6,c:"",f:null,t:null},{a:0,b:9,c:"hallo",f:null,t:null},{a:4,b:6,c:"x",f:3,t:4},{a:4,b:8,c:"",f:3,
t:4},{a:6,b:6,c:"a",f:3,t:6},{a:8,b:9,c:"",f:3,t:6}],function(c){a.setValue("1234567890");var d=a.markText(b(0,3),b(0,6),{className:"foo"});a.replaceRange(c.c,b(0,c.a),b(0,c.b));d=d.find();eq(d&&d.from.ch,c.f);eq(d&&d.to.ch,c.t)})});testCM("markTextMultiLine",function(a){function c(a){return a&&b(a[0],a[1])}m([{a:[0,0],b:[0,5],c:"",f:[0,0],t:[2,5]},{a:[0,0],b:[0,5],c:"foo\n",f:[1,0],t:[3,5]},{a:[0,1],b:[0,10],c:"",f:[0,1],t:[2,5]},{a:[0,5],b:[0,6],c:"x",f:[0,6],t:[2,5]},{a:[0,0],b:[1,0],c:"",f:[0,
0],t:[1,5]},{a:[0,6],b:[2,4],c:"",f:[0,5],t:[0,7]},{a:[0,6],b:[2,4],c:"aa",f:[0,5],t:[0,9]},{a:[1,2],b:[1,8],c:"",f:[0,5],t:[2,5]},{a:[0,5],b:[2,5],c:"xx",f:null,t:null},{a:[0,0],b:[2,10],c:"x",f:null,t:null},{a:[1,5],b:[2,5],c:"",f:[0,5],t:[1,5]},{a:[2,0],b:[2,3],c:"",f:[0,5],t:[2,2]},{a:[2,5],b:[3,0],c:"a\nb",f:[0,5],t:[2,5]},{a:[2,3],b:[3,0],c:"x",f:[0,5],t:[2,3]},{a:[1,1],b:[1,9],c:"1\n2\n3",f:[0,5],t:[4,5]}],function(d){a.setValue("aaaaaaaaaa\nbbbbbbbbbb\ncccccccccc\ndddddddd\n");var e=a.markText(b(0,
5),b(2,5),{className:"CodeMirror-matchingbracket"});a.replaceRange(d.c,c(d.a),c(d.b));e=e.find();eqPos(e&&e.from,c(d.f));eqPos(e&&e.to,c(d.t))})});testCM("markTextUndo",function(a){var c,d,e;c=a.markText(b(0,1),b(0,3),{className:"CodeMirror-matchingbracket"});d=a.markText(b(0,0),b(2,1),{className:"CodeMirror-matchingbracket"});e=a.setBookmark(b(1,5));a.operation(function(){a.replaceRange("foo",b(0,2));a.replaceRange("bar\nbaz\nbug\n",b(2,0),b(3,0))});var f=a.getValue();a.setValue("");eq(c.find(),
null);eq(d.find(),null);eq(e.find(),null);a.undo();eqPos(e.find(),b(1,5),"still there");a.undo();c=c.find();d=d.find();eqPos(c.from,b(0,1));eqPos(c.to,b(0,3));eqPos(d.from,b(0,0));eqPos(d.to,b(2,1));eqPos(e.find(),b(1,5));a.redo();a.redo();eq(e.find(),null);a.undo();eqPos(e.find(),b(1,5));eq(a.getValue(),f)},{value:"1234\n56789\n00\n"});testCM("markTextStayGone",function(a){var c=a.markText(b(0,0),b(0,1));a.replaceRange("hi",b(0,2));c.clear();a.undo();eq(c.find(),null)},{value:"hello"});testCM("markTextAllowEmpty",
function(a){var c=a.markText(b(0,1),b(0,2),{clearWhenEmpty:!1});is(c.find());a.replaceRange("x",b(0,0));is(c.find());a.replaceRange("y",b(0,2));is(c.find());a.replaceRange("z",b(0,3),b(0,4));is(!c.find());c=a.markText(b(0,1),b(0,2),{clearWhenEmpty:!1,inclusiveLeft:!0,inclusiveRight:!0});a.replaceRange("q",b(0,1),b(0,2));is(c.find());a.replaceRange("",b(0,0),b(0,3));is(!c.find());c=a.markText(b(0,1),b(0,1),{clearWhenEmpty:!1});a.replaceRange("a",b(0,3));is(c.find());a.replaceRange("b",b(0,1));is(!c.find())},
{value:"abcde"});testCM("markTextStacked",function(a){var c=a.markText(b(0,0),b(0,0),{clearWhenEmpty:!1}),d=a.markText(b(0,0),b(0,0),{clearWhenEmpty:!1});a.replaceRange("B",b(0,1));is(c.find()&&d.find())},{value:"A"});testCM("undoPreservesNewMarks",function(a){a.markText(b(0,3),b(0,4));a.markText(b(1,1),b(1,3));a.replaceRange("",b(0,3),b(3,1));var c=a.markText(b(0,0),b(0,1)),d=a.markText(b(0,5),b(0,6)),e=a.markText(b(0,2),b(0,4));a.undo();eqPos(c.find().from,b(0,0));eqPos(c.find().to,b(0,1));eqPos(d.find().from,
b(3,3));eqPos(d.find().to,b(3,4));eqPos(e.find().from,b(0,2));eqPos(e.find().to,b(3,2));a=a.findMarksAt(b(2,2));eq(a.length,1);eq(a[0],e)},{value:"aaaa\nbbbb\ncccc\ndddd"});testCM("markClearBetween",function(a){a.setValue("aaa\nbbb\nccc\nddd\n");a.markText(b(0,0),b(2));a.replaceRange("aaa\nbbb\nccc",b(0,0),b(2));eq(a.findMarksAt(b(1,1)).length,0)});testCM("deleteSpanCollapsedInclusiveLeft",function(a){var c=b(1,0),d=b(1,1);a.markText(c,d,{collapsed:!0,inclusiveLeft:!0});a.replaceRange("",c,d)},{value:"abc\nX\ndef"});
testCM("bookmark",function(a){function c(a){return a&&b(a[0],a[1])}m([{a:[1,0],b:[1,1],c:"",d:[1,4]},{a:[1,1],b:[1,1],c:"xx",d:[1,7]},{a:[1,4],b:[1,5],c:"ab",d:[1,6]},{a:[1,4],b:[1,6],c:"",d:null},{a:[1,5],b:[1,6],c:"abc",d:[1,5]},{a:[1,6],b:[1,8],c:"",d:[1,5]},{a:[1,4],b:[1,4],c:"\n\n",d:[3,1]},{bm:[1,9],a:[1,1],b:[1,1],c:"\n",d:[2,8]}],function(d){a.setValue("1234567890\n1234567890\n1234567890");var e=a.setBookmark(c(d.bm)||b(1,5));a.replaceRange(d.c,c(d.a),c(d.b));eqPos(e.find(),c(d.d))})});testCM("bookmarkInsertLeft",
function(a){var c=a.setBookmark(b(0,2),{insertLeft:!1}),d=a.setBookmark(b(0,2),{insertLeft:!0});a.setCursor(b(0,2));a.replaceSelection("hi");eqPos(c.find(),b(0,2));eqPos(d.find(),b(0,4));a.replaceRange("",b(0,4),b(0,5));a.replaceRange("",b(0,2),b(0,4));a.replaceRange("",b(0,1),b(0,2));eqPos(c.find(),b(0,1));eqPos(d.find(),b(0,1))},{value:"abcdef"});testCM("bookmarkCursor",function(a){var c=a.cursorCoords(b(0,1)),d=a.cursorCoords(b(1,1)),e=a.cursorCoords(b(2,0)),f=a.cursorCoords(b(3,0)),h=a.cursorCoords(b(4,
1));a.setBookmark(b(0,1),{widget:document.createTextNode("\u2190"),insertLeft:!0});a.setBookmark(b(2,0),{widget:document.createTextNode("\u2190"),insertLeft:!0});a.setBookmark(b(1,1),{widget:document.createTextNode("\u2192")});a.setBookmark(b(3,0),{widget:document.createTextNode("\u2192")});var g=a.cursorCoords(b(0,1)),l=a.cursorCoords(b(1,1)),k=a.cursorCoords(b(2,0)),n=a.cursorCoords(b(3,0));near(g.left,c.left,1);near(g.top,c.top,1);is(l.left>d.left,"at right, middle of line");near(l.top==d.top,
1);near(k.left,e.left,1);near(k.top,e.top,1);is(n.left>f.left,"at right, empty line");near(n.top,f,1);a.setBookmark(b(4,0),{widget:document.createTextNode("\u2192")});is(a.cursorCoords(b(4,1)).left>h.left,"single-char bug")},{value:"foo\nbar\n\n\nx\ny"});testCM("multiBookmarkCursor",function(a){function c(c){for(var e=0;3>e;++e){var f=document.createElement("span");f.innerHTML="X";d.push(a.setBookmark(b(0,1),{widget:f,insertLeft:c}))}}if(!q){var d=[],e;e=a.cursorCoords(b(0,1)).left;var f=a.cursorCoords(b(0,
4)).left;c(!0);for(near(e,a.cursorCoords(b(0,1)).left,1);e=d.pop();)e.clear();c(!1);near(f,a.cursorCoords(b(0,1)).left,1)}},{value:"abcdefg"});testCM("getAllMarks",function(a){g(a,10,10);var c=a.setBookmark(b(0,2));a.markText(b(0,2),b(3,2));var d=a.markText(b(1,2),b(1,8));a.markText(b(8,0),b(9,0));eq(a.getAllMarks().length,4);c.clear();d.clear();eq(a.getAllMarks().length,2)});testCM("bug577",function(a){a.setValue("a\nb");a.clearHistory();a.setValue("fooooo");a.undo()});testCM("scrollSnap",function(a){a.setSize(100,
100);g(a,200,200);a.setCursor(b(100,180));var c=a.getScrollInfo();is(0<c.left&&0<c.top);a.setCursor(b(0,0));c=a.getScrollInfo();is(0==c.left&&0==c.top,"scrolled clean to top");a.setCursor(b(100,180));a.setCursor(b(199,0));c=a.getScrollInfo();is(0==c.left&&c.top+2>c.height-a.getScrollerElement().clientHeight,"scrolled clean to bottom")});testCM("scrollIntoView",function(a){function c(c,f,h){c=b(c,f);a.scrollIntoView(c);c=a.charCoords(c,"window");is(c.left>=d.left,h+" (left)");is(c.right<=d.right,h+
" (right)");is(c.top>=d.top,h+" (top)");is(c.bottom<=d.bottom,h+" (bottom)")}if(!q){var d=a.getWrapperElement().getBoundingClientRect();g(a,200,200);c(199,199,"bottom right");c(0,0,"top left");c(100,100,"center");c(199,0,"bottom left");c(0,199,"top right");c(100,100,"center again")}});testCM("scrollBackAndForth",function(a){g(a,1,200);a.operation(function(){a.scrollIntoView(b(199,0));a.scrollIntoView(b(4,0))});is(0<a.getScrollInfo().top)});testCM("selectAllNoScroll",function(a){g(a,1,200);a.execCommand("selectAll");
eq(a.getScrollInfo().top,0);a.setCursor(199);a.execCommand("selectAll");is(0<a.getScrollInfo().top)});testCM("selectionPos",function(a){if(!q){a.setSize(100,100);g(a,200,100);a.setSelection(b(1,100),b(98,100));var c=a.charCoords(b(0,200),"local").left,d=(a.charCoords(b(99)).top-a.charCoords(b(0)).top)/100;a.scrollTo(0,0);var e=k(a.getWrapperElement(),"CodeMirror-selected");a=a.getWrapperElement().getBoundingClientRect();for(var f,h,w,l=0,p=e.length;l<p;++l){var n=e[l].getBoundingClientRect(),m=30>
n.left-a.left,r=n.right-n.left,s=n.right-a.left>0.8*c;m&&s?(f=!0,is(n.bottom-n.top>90*d,"middle high"),is(r>0.9*c,"middle wide")):(is(r>0.4*c,"top/bot wide enough"),is(r<0.6*c,"top/bot slim enough"),m?(w=!0,is(n.top-a.top>96*d,"bot below")):s&&(h=!0,is(n.top-a.top<2.1*d,"top above")))}is(h&&w&&f,"all parts")}},null);testCM("restoreHistory",function(a){a.setValue("abc\ndef");a.replaceRange("hello",b(1,0),b(1));a.replaceRange("goop",b(0,0),b(0));a.undo();var c=a.getValue(),d=a.getHistory();window.JSON&&
(d=JSON.parse(JSON.stringify(d)));eq(c,"abc\nhello");a.setValue("");a.clearHistory();eq(a.historySize().undo,0);a.setValue(c);a.setHistory(d);a.redo();eq(a.getValue(),"goop\nhello");a.undo();a.undo();eq(a.getValue(),"abc\ndef")});testCM("doubleScrollbar",function(a){var b=document.body.appendChild(document.createElement("p"));b.style.cssText="height: 50px; overflow: scroll; width: 50px";var d=b.offsetWidth+1-b.clientWidth;document.body.removeChild(b);2>d||(a.setSize(null,100),g(a,1,300),a=a.getWrapperElement(),
is(a.offsetWidth-k(a,"CodeMirror-lines")[0].offsetWidth<=1.5*d))});testCM("weirdLinebreaks",function(a){a.setValue("foo\nbar\rbaz\r\nquux\n\rplop");is(a.getValue(),"foo\nbar\nbaz\nquux\n\nplop");is(a.lineCount(),6);a.setValue("\n\n");is(a.lineCount(),3)});testCM("setSize",function(a){a.setSize(100,100);var b=a.getWrapperElement();is(b.offsetWidth,100);is(b.offsetHeight,100);a.setSize("100%","3em");is(b.style.width,"100%");is(b.style.height,"3em");a.setSize(null,40);is(b.style.width,"100%");is(b.style.height,
"40px")});testCM("collapsedLines",function(a){g(a,4,10);var c=p(a,4,5),d=0;CodeMirror.on(c,"clear",function(){d++});a.setCursor(b(3,0));CodeMirror.commands.goLineDown(a);eqPos(a.getCursor(),b(5,0));a.replaceRange("abcdefg",b(3,0),b(3));a.setCursor(b(3,6));CodeMirror.commands.goLineDown(a);eqPos(a.getCursor(),b(5,4));a.replaceRange("ab",b(3,0),b(3));a.setCursor(b(3,2));CodeMirror.commands.goLineDown(a);eqPos(a.getCursor(),b(5,2));a.operation(function(){c.clear();c.clear()});eq(d,1)});testCM("collapsedRangeCoordsChar",
function(a){var c=a.charCoords(b(1,3));c.left+=2;c.top+=2;var d={collapsed:!0,inclusiveLeft:!0,inclusiveRight:!0},e=a.markText(b(0,0),b(2,0),d);eqPos(a.coordsChar(c),b(3,3));e.clear();var e=a.markText(b(0,0),b(1,1),{collapsed:!0,inclusiveLeft:!0}),f=a.markText(b(1,1),b(2,0),{collapsed:!0,inclusiveRight:!0});eqPos(a.coordsChar(c),b(3,3));e.clear();f.clear();a.markText(b(0,0),b(1,6),d);eqPos(a.coordsChar(c),b(3,3))},{value:"123456\nabcdef\nghijkl\nmnopqr\n"});testCM("collapsedRangeBetweenLinesSelected",
function(a){var c=document.createElement("span");c.textContent="\u2194";a.markText(b(0,3),b(1,0),{replacedWith:c});a.setSelection(b(0,3),b(1,0));a=k(a.getWrapperElement(),"CodeMirror-selected");for(var d=c=0;c<a.length;c++)d+=a[c].offsetWidth;is(0<d)},{value:"one\ntwo"});testCM("randomCollapsedRanges",function(a){g(a,20,500);a.operation(function(){for(var c=0;200>c;c++){var d=b(Math.floor(500*Math.random()),Math.floor(20*Math.random()));if(c%4)try{a.markText(d,b(d.line+2,1),{collapsed:!0})}catch(e){if(!/overlapping/.test(String(e)))throw e;
}else a.markText(d,b(d.line,d.ch+4),{className:"foo"})}})});testCM("hiddenLinesAutoUnfold",function(a){var c=p(a,1,3,!0),d=0;CodeMirror.on(c,"clear",function(){d++});a.setCursor(b(3,0));eq(d,0);a.execCommand("goCharLeft");eq(d,1);c=p(a,1,3,!0);CodeMirror.on(c,"clear",function(){d++});eqPos(a.getCursor(),b(3,0));a.setCursor(b(0,3));a.execCommand("goCharRight");eq(d,2)},{value:"abc\ndef\nghi\njkl"});testCM("hiddenLinesSelectAll",function(a){g(a,4,20);p(a,0,10);p(a,11,20);CodeMirror.commands.selectAll(a);
eqPos(a.getCursor(!0),b(10,0));eqPos(a.getCursor(!1),b(10,4))});testCM("everythingFolded",function(a){function b(){a.triggerOnKeyDown({type:"keydown",keyCode:13,preventDefault:function(){},stopPropagation:function(){}})}g(a,2,2);var d=p(a,0,2);b();eq(a.getValue(),"xx\nxx");d.clear();d=p(a,0,2,!0);eq(d.find(),null);b();eq(a.getValue(),"\nxx\nxx")});testCM("structuredFold",function(a){if(!q){g(a,4,8);var c=a.markText(b(1,2),b(6,2),{replacedWith:document.createTextNode("Q")});a.setCursor(0,3);CodeMirror.commands.goLineDown(a);
eqPos(a.getCursor(),b(6,2));CodeMirror.commands.goCharLeft(a);eqPos(a.getCursor(),b(1,2));CodeMirror.commands.delCharAfter(a);eq(a.getValue(),"xxxx\nxxxx\nxxxx");g(a,4,8);var c=a.markText(b(1,2),b(6,2),{replacedWith:document.createTextNode("M"),clearOnEnter:!0}),d=0;CodeMirror.on(c,"clear",function(){++d});a.setCursor(0,3);CodeMirror.commands.goLineDown(a);eqPos(a.getCursor(),b(6,2));CodeMirror.commands.goCharLeft(a);eqPos(a.getCursor(),b(6,1));eq(d,1);c.clear();eq(d,1);c=a.markText(b(1,2),b(6,2),
{replacedWith:document.createTextNode("Q"),clearOnEnter:!0});c.clear();a.setCursor(1,2);CodeMirror.commands.goCharRight(a);eqPos(a.getCursor(),b(1,3));c=a.markText(b(2,0),b(4,4),{replacedWith:document.createTextNode("M")});a.setCursor(1,0);CodeMirror.commands.goLineDown(a);eqPos(a.getCursor(),b(2,0))}},null);testCM("nestedFold",function(a){function c(c,d,e,f){return a.markText(b(c,d),b(e,f),{collapsed:!0})}g(a,10,3);c(0,6,1,3);var d=c(0,2,1,8),e=c(0,1,2,3),f=c(0,5,0,6);a.setCursor(0,1);CodeMirror.commands.goCharRight(a);
eqPos(a.getCursor(),b(2,3));f.clear();CodeMirror.commands.goCharLeft(a);eqPos(a.getCursor(),b(0,1));e.clear();CodeMirror.commands.goCharRight(a);eqPos(a.getCursor(),b(0,2));CodeMirror.commands.goCharRight(a);eqPos(a.getCursor(),b(1,8));d.clear();CodeMirror.commands.goCharLeft(a);eqPos(a.getCursor(),b(1,7));a.setCursor(0,5);CodeMirror.commands.goCharRight(a);eqPos(a.getCursor(),b(0,6));CodeMirror.commands.goCharRight(a);eqPos(a.getCursor(),b(1,3))});testCM("badNestedFold",function(a){g(a,4,4);a.markText(b(0,
2),b(3,2),{collapsed:!0});var c;try{a.markText(b(0,1),b(0,3),{collapsed:!0})}catch(d){c=d}is(c instanceof Error,"no error");is(/overlap/i.test(c.message),"wrong error")});testCM("nestedFoldOnSide",function(a){var c=a.markText(b(0,1),b(2,1),{collapsed:!0,inclusiveRight:!0});a.markText(b(0,1),b(0,2),{collapsed:!0});a.markText(b(0,1),b(0,2),{collapsed:!0}).clear();try{a.markText(b(0,1),b(0,2),{collapsed:!0,inclusiveLeft:!0})}catch(d){var e=d}is(e&&/overlap/i.test(e.message));a.markText(b(2,0),b(2,1),
{collapsed:!0});var f=a.markText(b(2,0),b(2,1),{collapse:!0,inclusiveRight:!0});c.clear();f.clear();a.markText(b(0,1),b(2,1),{collapsed:!0});a.markText(b(2,0),b(2,1),{collapsed:!0}).clear();try{a.markText(b(2,0),b(2,1),{collapsed:!0,inclusiveRight:!0})}catch(h){e=h}is(e&&/overlap/i.test(e.message))},{value:"ab\ncdef"});testCM("editInFold",function(a){g(a,4,6);a.markText(b(1,2),b(3,2),{collapsed:!0});a.replaceRange("",b(0,0),b(1,3));a.replaceRange("",b(2,1),b(3,3));a.replaceRange("a\nb\nc\nd",b(0,
1),b(1,0));a.cursorCoords(b(0,0))});testCM("wrappingInlineWidget",function(a){a.setSize("11em");var c=document.createElement("span");c.style.color="red";c.innerHTML="one two three four";a.markText(b(0,6),b(0,9),{replacedWith:c});var c=a.cursorCoords(b(0,0)),d=a.cursorCoords(b(0,10));is(c.top<d.top);is(c.bottom<d.bottom);var e=a.cursorCoords(b(0,6)),f=a.cursorCoords(b(0,9));eq(e.top,c.top);eq(e.bottom,c.bottom);eq(f.top,d.top);eq(f.bottom,d.bottom);a.replaceRange("",b(0,9),b(0));f=a.cursorCoords(b(0,
9));q||(eq(f.top,d.top),eq(f.bottom,d.bottom))},{value:"1 2 3 xxx 4",lineWrapping:!0});testCM("changedInlineWidget",function(a){a.setSize("10em");var c=document.createElement("span");c.innerHTML="x";var d=a.markText(b(0,4),b(0,5),{replacedWith:c});c.innerHTML="and now the widget is really really long all of a sudden and a scrollbar is needed";d.changed();a=k(a.getWrapperElement(),"CodeMirror-hscrollbar")[0];is(a.scrollWidth>a.clientWidth)},{value:"hello there"});testCM("changedBookmark",function(a){a.setSize("10em");
var c=document.createElement("span");c.innerHTML="x";var d=a.setBookmark(b(0,4),{widget:c});c.innerHTML="and now the widget is really really long all of a sudden and a scrollbar is needed";d.changed();a=k(a.getWrapperElement(),"CodeMirror-hscrollbar")[0];is(a.scrollWidth>a.clientWidth)},{value:"abcdefg"});testCM("inlineWidget",function(a){var c=a.setBookmark(b(0,2),{widget:document.createTextNode("uu")});a.setCursor(0,2);CodeMirror.commands.goLineDown(a);eqPos(a.getCursor(),b(1,4));a.setCursor(0,
2);a.replaceSelection("hi");eqPos(c.find(),b(0,2));a.setCursor(0,1);a.replaceSelection("ay");eqPos(c.find(),b(0,4));eq(a.getLine(0),"uayuhiuu")},{value:"uuuu\nuuuuuu"});testCM("wrappingAndResizing",function(a){a.setSize(null,"auto");a.setOption("lineWrapping",!0);var c=a.getWrapperElement(),d=c.offsetHeight;a.setValue("xxx xxx xxx xxx xxx");for(var e=10,f=a.charCoords(b(0,18),"div").right;;f+=e)if(a.setSize(f),c.offsetHeight<=d*(t?1.2:1.5))if(10==e)f-=10,e=1;else break;a.setCursor(b(0,19));eq(c.offsetHeight,
d);a.replaceSelection("x");is(c.offsetHeight>d,"wrapping happens");a.setValue("xxx xxx xxx xxx xxx\nxxx xxx xxx xxx xxx\n");a.getScrollerElement().style.maxHeight="100px";a.replaceRange("\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n!\n",b(2,0));m([b(0,19),b(0,18),b(0,0),b(1,19),b(1,18)],function(b){var c=a.charCoords(b);eqPos(b,a.coordsChar({left:c.left+2,top:c.top+5}))})},null,s);testCM("measureEndOfLine",function(a){a.setSize(null,"auto");for(var c=k(a.getWrapperElement(),"CodeMirror-lines")[0].firstChild,
d=c.offsetHeight,e=10,f=a.charCoords(b(0,7),"div").right;;f+=e)if(a.setSize(f),c.offsetHeight<2.5*d)if(10==e)f-=10,e=1;else break;a.setValue(a.getValue()+"\n\n");c=a.charCoords(b(0,18),"local");is(c.top>0.8*d,"not at top");is(c.left>f-20,"not at right");c=a.charCoords(b(0,18));eqPos(a.coordsChar({left:c.left,top:c.top+5}),b(0,18))},{mode:"text/html",value:"\x3c!-- foo barrr --\x3e",lineWrapping:!0},s||t);testCM("scrollVerticallyAndHorizontally",function(a){a.setSize(100,100);g(a,40,40);a.setCursor(39);
var b=a.getWrapperElement(),d=k(b,"CodeMirror-vscrollbar")[0];is(d.offsetHeight<b.offsetHeight,"vertical scrollbar limited by horizontal one");d=k(b,"CodeMirror-cursor")[0].getBoundingClientRect();b=b.getBoundingClientRect();is(d.bottom<b.top+a.getScrollerElement().clientHeight,"bottom line visible")},{lineNumbers:!0});testCM("moveVstuck",function(a){var c=k(a.getWrapperElement(),"CodeMirror-lines")[0].firstChild,d=c.offsetHeight;a.setValue("fooooooooooooooooooooooooo baaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaar\n");
for(var e=2.8*a.charCoords(b(0,26),"div").right;!(a.setSize(e),c.offsetHeight<=3.5*d);e+=5);a.setCursor(b(0,104));a.moveV(-1,"line");eqPos(a.getCursor(),b(0,26))},{lineWrapping:!0},s||t);testCM("collapseOnMove",function(a){a.setSelection(b(0,1),b(2,4));a.execCommand("goLineUp");is(!a.somethingSelected());eqPos(a.getCursor(),b(0,1));a.setSelection(b(0,1),b(2,4));a.execCommand("goPageDown");is(!a.somethingSelected());eqPos(a.getCursor(),b(2,4));a.execCommand("goLineUp");a.execCommand("goLineUp");eqPos(a.getCursor(),
b(0,4));a.setSelection(b(0,1),b(2,4));a.execCommand("goCharLeft");is(!a.somethingSelected());eqPos(a.getCursor(),b(0,1))},{value:"aaaaa\nb\nccccc"});testCM("clickTab",function(a){var c=a.charCoords(b(0,0));eqPos(a.coordsChar({left:c.left+5,top:c.top+5}),b(0,0));eqPos(a.coordsChar({left:c.right-5,top:c.top+5}),b(0,1))},{value:"\t\n\n",lineWrapping:!0,tabSize:8});testCM("verticalScroll",function(a){a.setSize(100,200);a.setValue("foo\nbar\nbaz\n");var c=a.getScrollerElement(),d=c.scrollWidth;a.replaceRange("aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaah",
b(0,0),b(0));is(c.scrollWidth>d,"scrollbar present");a.replaceRange("foo",b(0,0),b(0));q||eq(c.scrollWidth,d,"scrollbar gone");a.replaceRange("aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaah",b(0,0),b(0));a.replaceRange("bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbh",b(1,0),b(1));is(c.scrollWidth>d,"present again");var e=c.scrollWidth;a.replaceRange("foo",b(0,0),b(0));is(c.scrollWidth<e,"scrollbar smaller");is(c.scrollWidth>
d,"but still present")});testCM("extraKeys",function(a){function b(c,f,h){"string"==typeof f&&(f=f.charCodeAt(0));f={type:"keydown",keyCode:f,preventDefault:function(){},stopPropagation:function(){}};if(h)for(var g in h)f[g]=h[g];d=null;a.triggerOnKeyDown(f);eq(d,c)}var d;CodeMirror.commands.testCommand=function(){d="tc"};CodeMirror.commands.goTestCommand=function(){d="gtc"};a.setOption("extraKeys",{"Shift-X":function(){d="sx"},X:function(){d="x"},"Ctrl-Alt-U":function(){d="cau"},End:"testCommand",
Home:"goTestCommand",Tab:!1});b(null,"U");b("cau","U",{ctrlKey:!0,altKey:!0});b(null,"U",{shiftKey:!0,ctrlKey:!0,altKey:!0});b("x","X");b("sx","X",{shiftKey:!0});b("tc",35);b(null,35,{shiftKey:!0});b("gtc",36);b("gtc",36,{shiftKey:!0});b(null,9)},null,window.opera&&v);testCM("wordMovementCommands",function(a){a.execCommand("goWordLeft");eqPos(a.getCursor(),b(0,0));a.execCommand("goWordRight");a.execCommand("goWordRight");eqPos(a.getCursor(),b(0,7));a.execCommand("goWordLeft");eqPos(a.getCursor(),
b(0,5));a.execCommand("goWordRight");a.execCommand("goWordRight");eqPos(a.getCursor(),b(0,12));a.execCommand("goWordLeft");eqPos(a.getCursor(),b(0,9));a.execCommand("goWordRight");a.execCommand("goWordRight");a.execCommand("goWordRight");eqPos(a.getCursor(),b(0,24));a.execCommand("goWordRight");a.execCommand("goWordRight");eqPos(a.getCursor(),b(1,9));a.execCommand("goWordRight");eqPos(a.getCursor(),b(1,13));a.execCommand("goWordRight");a.execCommand("goWordRight");eqPos(a.getCursor(),b(2,0))},{value:"this is (the) firstline.\na foo12\u00e9\u00f8\u00d7bar\n"});
testCM("groupMovementCommands",function(a){a.execCommand("goGroupLeft");eqPos(a.getCursor(),b(0,0));a.execCommand("goGroupRight");eqPos(a.getCursor(),b(0,4));a.execCommand("goGroupRight");eqPos(a.getCursor(),b(0,7));a.execCommand("goGroupRight");eqPos(a.getCursor(),b(0,10));a.execCommand("goGroupLeft");eqPos(a.getCursor(),b(0,7));a.execCommand("goGroupRight");a.execCommand("goGroupRight");a.execCommand("goGroupRight");eqPos(a.getCursor(),b(0,15));a.setCursor(b(0,17));a.execCommand("goGroupLeft");
eqPos(a.getCursor(),b(0,16));a.execCommand("goGroupLeft");eqPos(a.getCursor(),b(0,14));a.execCommand("goGroupRight");a.execCommand("goGroupRight");eqPos(a.getCursor(),b(0,20));a.execCommand("goGroupRight");eqPos(a.getCursor(),b(1,0));a.execCommand("goGroupRight");eqPos(a.getCursor(),b(1,2));a.execCommand("goGroupRight");eqPos(a.getCursor(),b(1,5));a.execCommand("goGroupLeft");a.execCommand("goGroupLeft");eqPos(a.getCursor(),b(1,0));a.execCommand("goGroupLeft");eqPos(a.getCursor(),b(0,20));a.execCommand("goGroupLeft");
eqPos(a.getCursor(),b(0,16))},{value:"booo ba---quux. ffff\n  abc d"});testCM("groupsAndWhitespace",function(a){for(var c=[b(0,0),b(0,2),b(0,5),b(0,9),b(0,11),b(1,0),b(1,2),b(1,5)],d=1;d<c.length;d++)a.execCommand("goGroupRight"),eqPos(a.getCursor(),c[d]);for(d=c.length-2;0<=d;d--)a.execCommand("goGroupLeft"),eqPos(a.getCursor(),2==d?b(0,6):c[d])},{value:"  foo +++  \n  bar"});testCM("charMovementCommands",function(a){a.execCommand("goCharLeft");a.execCommand("goColumnLeft");eqPos(a.getCursor(),b(0,
0));a.execCommand("goCharRight");a.execCommand("goCharRight");eqPos(a.getCursor(),b(0,2));a.setCursor(b(1,0));a.execCommand("goColumnLeft");eqPos(a.getCursor(),b(1,0));a.execCommand("goCharLeft");eqPos(a.getCursor(),b(0,5));a.execCommand("goColumnRight");eqPos(a.getCursor(),b(0,5));a.execCommand("goCharRight");eqPos(a.getCursor(),b(1,0));a.execCommand("goLineEnd");eqPos(a.getCursor(),b(1,5));a.execCommand("goLineStartSmart");eqPos(a.getCursor(),b(1,1));a.execCommand("goLineStartSmart");eqPos(a.getCursor(),
b(1,0));a.setCursor(b(2,0));a.execCommand("goCharRight");a.execCommand("goColumnRight");eqPos(a.getCursor(),b(2,0))},{value:"line1\n ine2\n"});testCM("verticalMovementCommands",function(a){a.execCommand("goLineUp");eqPos(a.getCursor(),b(0,0));a.execCommand("goLineDown");q||eqPos(a.getCursor(),b(1,0));a.setCursor(b(1,12));a.execCommand("goLineDown");eqPos(a.getCursor(),b(2,5));a.execCommand("goLineDown");eqPos(a.getCursor(),b(3,0));a.execCommand("goLineUp");eqPos(a.getCursor(),b(2,5));a.execCommand("goLineUp");
eqPos(a.getCursor(),b(1,12));a.execCommand("goPageDown");eqPos(a.getCursor(),b(5,0));a.execCommand("goPageDown");a.execCommand("goLineDown");eqPos(a.getCursor(),b(5,0));a.execCommand("goPageUp");eqPos(a.getCursor(),b(0,0))},{value:"line1\nlong long line2\nline3\n\nline5\n"});testCM("verticalMovementCommandsWrapping",function(a){a.setSize(120);a.setCursor(b(0,5));a.execCommand("goLineDown");eq(a.getCursor().line,0);is(5<a.getCursor().ch,"moved beyond wrap");for(var c=0;;++c){is(20>c,"no endless loop");
a.execCommand("goLineDown");var d=a.getCursor();1==d.line&&eq(d.ch,5);if(2==d.line){eq(d.ch,1);break}}},{value:"a very long line that wraps around somehow so that we can test cursor movement\nshortone\nk",lineWrapping:!0});testCM("rtlMovement",function(a){m('\u062e\u062d\u062c;\u062e\u062dabc\u062e\u062d\u062c;ab\u062e\u062d\u062e\u062d\u062ccd;ab\u062ede;ab\u062e\u062d2342\u062e1\u062d\u062c;\u062e1\u062d2\u062e\u062d3\u062dx\u062c;\u062e\u062dcd;1\u062e\u062dcd;abcde\u062d1\u062c;\u062e\u0645\u0631\u062d\u0628\u0647\u0627 \u0645\u0647\u0627!;foobar\u0631;\u062e \u0629 \u0642;\x3cimg src\x3d"/\u05d1\u05d3\u05d9\u05e7\u05d43.jpg"\x3e'.split(";"),
function(b){var d="\u062e"==b.charAt(0);a.setValue(b+"\n");a.execCommand(d?"goLineEnd":"goLineStart");for(var e=k(a.getWrapperElement(),"CodeMirror-cursors")[0],f=e.firstChild,h=f.offsetLeft,g=f.offsetTop,l=0;l<=b.length;++l)a.execCommand("goCharRight"),f=e.firstChild,l==b.length?is(f.offsetTop>g,"next line"):is(f.offsetLeft>h,"moved right"),h=f.offsetLeft,g=f.offsetTop;a.setCursor(0,0);a.execCommand(d?"goLineStart":"goLineEnd");h=e.firstChild.offsetLeft;for(l=0;l<b.length;++l)a.execCommand("goCharLeft"),
f=e.firstChild,is(f.offsetLeft<h,"moved left"),h=f.offsetLeft})},null,u);testCM("bidiUpdate",function(a){a.setCursor(b(0,2));a.replaceSelection("\u062e\u062d\u062c","start");a.execCommand("goCharRight");eqPos(a.getCursor(),b(0,4))},{value:"abcd\n"});testCM("movebyTextUnit",function(a){a.setValue("\u05d1\u05b0\u05bc\u05e8\u05b5\u05d0\u05e9\u05b4\ne\u0301e\u0301e\u0301\u0301\n");a.execCommand("goLineEnd");for(var c=0;4>c;++c)a.execCommand("goCharRight");eqPos(a.getCursor(),b(0,0));a.execCommand("goCharRight");
eqPos(a.getCursor(),b(1,0));a.execCommand("goCharRight");a.execCommand("goCharRight");eqPos(a.getCursor(),b(1,4));a.execCommand("goCharRight");eqPos(a.getCursor(),b(1,7))});testCM("lineChangeEvents",function(a){g(a,3,5);for(var c=[],d="ch 0;ch 1;del 2;ch 0;ch 0;del 1;del 3;del 4".split(";"),e=0;5>e;++e)CodeMirror.on(a.getLineHandle(e),"delete",function(a){return function(){c.push("del "+a)}}(e)),CodeMirror.on(a.getLineHandle(e),"change",function(a){return function(){c.push("ch "+a)}}(e));a.replaceRange("x",
b(0,1));a.replaceRange("xy",b(1,1),b(2));a.replaceRange("foo\nbar",b(0,1));a.replaceRange("",b(0,0),b(a.lineCount()));eq(c.length,d.length,"same length");for(e=0;e<c.length;++e)eq(c[e],d[e])});testCM("scrollEntirelyToRight",function(a){if(!q){g(a,500,2);a.setCursor(b(0,500));a=a.getWrapperElement();var c=k(a,"CodeMirror-cursor")[0];is(a.getBoundingClientRect().right>c.getBoundingClientRect().left)}});testCM("lineWidgets",function(a){g(a,500,3);var c=a.charCoords(b(2,0)),d=document.createElement("div");
d.innerHTML="hi";a.addLineWidget(1,d);is(c.top<a.charCoords(b(2,0)).top,"took up space");a.setCursor(b(1,1));a.execCommand("goLineDown");eqPos(a.getCursor(),b(2,1));a.execCommand("goLineUp");eqPos(a.getCursor(),b(1,1))});testCM("lineWidgetFocus",function(a){var c=document.getElementById("testground");c.className="offscreen";try{g(a,500,10);var d=document.createElement("input");a.addLineWidget(1,d);d.focus();eq(document.activeElement,d);a.replaceRange("new stuff",b(1,0));eq(document.activeElement,
d)}finally{c.className=""}});testCM("lineWidgetCautiousRedraw",function(a){var b=document.createElement("div");b.innerHTML="hahah";var d=!1;a.addLineWidget(0,b).on("redraw",function(){d=!0});a.replaceSelection("0");is(!d)},{value:"123\n456"});testCM("lineWidgetChanged",function(a){function b(){var a=document.createElement("div");a.style.cssText="background: yellow; height: 50px;";return a}g(a,2,300);a.setSize(null,50*a.defaultTextHeight());a.scrollTo(null,a.heightAtLine(125,"local"));var d=a.getScrollInfo(),
e=a.addLineWidget(0,b()),f=a.addLineWidget(150,b()),h=a.addLineWidget(300,b()),k=a.getScrollInfo();eq(d.height+150,k.height);eq(d.top+50,k.top);e.node.style.height=f.node.style.height=h.node.style.height="10px";e.changed();f.changed();h.changed();a=a.getScrollInfo();eq(d.height+30,a.height);eq(d.top+10,a.top)});testCM("getLineNumber",function(a){g(a,2,20);var c=a.getLineHandle(1);eq(a.getLineNumber(c),1);a.replaceRange("hi\nbye\n",b(0,0));eq(a.getLineNumber(c),3);a.setValue("");eq(a.getLineNumber(c),
null)});testCM("jumpTheGap",function(a){if(!q){var c="abcdef ghiklmnop qrstuvw xyz ",c=c+c,c=c+c;a.replaceRange(c+c,b(2,0),b(2));a.setSize("200px",null);a.getWrapperElement().style.lineHeight=2;a.refresh();a.setCursor(b(0,1));a.execCommand("goLineDown");eqPos(a.getCursor(),b(1,1));a.execCommand("goLineDown");eqPos(a.getCursor(),b(2,1));a.execCommand("goLineDown");eq(a.getCursor().line,2);is(1<a.getCursor().ch);a.execCommand("goLineUp");eqPos(a.getCursor(),b(2,1));a.execCommand("goLineUp");eqPos(a.getCursor(),
b(1,1));c=document.createElement("div");c.innerHTML="hi";c.style.height="30px";a.addLineWidget(0,c);a.addLineWidget(1,c.cloneNode(!0),{above:!0});a.setCursor(b(0,2));a.execCommand("goLineDown");eqPos(a.getCursor(),b(1,2));a.execCommand("goLineUp");eqPos(a.getCursor(),b(0,2))}},{lineWrapping:!0,value:"abc\ndef\nghi\njkl\n"});testCM("addLineClass",function(a){function b(c,d,h,g){c=a.lineInfo(c);eq(c.textClass,d);eq(c.bgClass,h);eq(c.wrapClass,g)}a.addLineClass(0,"text","foo");a.addLineClass(0,"text",
"bar");a.addLineClass(1,"background","baz");a.addLineClass(1,"wrap","foo");b(0,"foo bar",null,null);b(1,null,"baz","foo");var d=a.display.lineDiv;eq(k(d,"foo").length,2);eq(k(d,"bar").length,1);eq(k(d,"baz").length,1);a.removeLineClass(0,"text","foo");b(0,"bar",null,null);a.removeLineClass(0,"text","foo");b(0,"bar",null,null);a.removeLineClass(0,"text","bar");b(0,null,null,null);a.addLineClass(1,"wrap","quux");b(1,null,"baz","foo quux");a.removeLineClass(1,"wrap");b(1,null,"baz",null)},{value:"hohoho\n"});
testCM("atomicMarker",function(a){function c(c,d,h,g,k,m){return a.markText(b(c,d),b(h,g),{atomic:!0,inclusiveLeft:k,inclusiveRight:m})}g(a,10,10);var d=c(0,1,0,5);a.setCursor(b(0,1));a.execCommand("goCharRight");eqPos(a.getCursor(),b(0,5));a.execCommand("goCharLeft");eqPos(a.getCursor(),b(0,1));d.clear();d=c(0,0,0,5,!0);eqPos(a.getCursor(),b(0,5),"pushed out");a.execCommand("goCharLeft");eqPos(a.getCursor(),b(0,5));d.clear();d=c(8,4,9,10,!1,!0);a.setCursor(b(9,8));eqPos(a.getCursor(),b(8,4),"set");
a.execCommand("goCharRight");eqPos(a.getCursor(),b(8,4),"char right");a.execCommand("goLineDown");eqPos(a.getCursor(),b(8,4),"line down");a.execCommand("goCharLeft");eqPos(a.getCursor(),b(8,3));d.clear();d=c(1,1,3,8);a.setCursor(b(0,0));a.setCursor(b(2,0));eqPos(a.getCursor(),b(3,8));a.execCommand("goCharLeft");eqPos(a.getCursor(),b(1,1));a.execCommand("goCharRight");eqPos(a.getCursor(),b(3,8));a.execCommand("goLineUp");eqPos(a.getCursor(),b(1,1));a.execCommand("goLineDown");eqPos(a.getCursor(),b(3,
8));a.execCommand("delCharBefore");eq(a.getValue().length,80,"del chunk");d=c(3,0,5,5);a.setCursor(b(3,0));a.execCommand("delWordAfter");eq(a.getValue().length,53,"del chunk")});testCM("readOnlyMarker",function(a){var c=a.markText(b(0,1),b(0,4),{readOnly:!0,atomic:void 0});a.setCursor(b(0,2));a.replaceSelection("hi","end");eqPos(a.getCursor(),b(0,2));eq(a.getLine(0),"abcde");a.execCommand("selectAll");a.replaceSelection("oops","around");eq(a.getValue(),"oopsbcd");a.undo();eqPos(c.find().from,b(0,
1));eqPos(c.find().to,b(0,4));c.clear();a.setCursor(b(0,2));a.replaceSelection("hi","around");eq(a.getLine(0),"abhicde");eqPos(a.getCursor(),b(0,4));a.markText(b(0,2),b(2,2),{readOnly:!0,atomic:!0});a.setSelection(b(1,1),b(2,4));a.replaceSelection("t","end");eqPos(a.getCursor(),b(2,3));eq(a.getLine(2),"klto");a.execCommand("goCharLeft");a.execCommand("goCharLeft");eqPos(a.getCursor(),b(0,2));a.setSelection(b(0,1),b(0,3));a.replaceSelection("xx","around");eqPos(a.getCursor(),b(0,3));eq(a.getLine(0),
"axxhicde")},{value:"abcde\nfghij\nklmno\n"});testCM("dirtyBit",function(a){eq(a.isClean(),!0);a.replaceSelection("boo",null,"test");eq(a.isClean(),!1);a.undo();eq(a.isClean(),!0);a.replaceSelection("boo",null,"test");a.replaceSelection("baz",null,"test");a.undo();eq(a.isClean(),!1);a.markClean();eq(a.isClean(),!0);a.undo();eq(a.isClean(),!1);a.redo();eq(a.isClean(),!0)});testCM("changeGeneration",function(a){a.replaceSelection("x");var b=a.changeGeneration();a.replaceSelection("x");a.undo();eq(a.getValue(),
"");is(!a.isClean(b));a.replaceSelection("x");b=a.changeGeneration(!0);a.replaceSelection("x");a.undo();eq(a.getValue(),"x");is(a.isClean(b))});testCM("addKeyMap",function(a){function c(b){a.triggerOnKeyDown({type:"keydown",keyCode:b,preventDefault:function(){},stopPropagation:function(){}})}c(39);eqPos(a.getCursor(),b(0,1));var d=0,e={Right:function(){++d}},f={Right:function(){d+=10}};a.addKeyMap(e);c(39);eqPos(a.getCursor(),b(0,1));eq(d,1);a.addKeyMap(f,!0);c(39);eq(d,2);a.removeKeyMap(e);c(39);
eq(d,12);a.removeKeyMap(f);c(39);eq(d,12);eqPos(a.getCursor(),b(0,2));a.addKeyMap({Right:function(){d=55},name:"mymap"});c(39);eq(d,55);a.removeKeyMap("mymap");c(39);eqPos(a.getCursor(),b(0,3))},{value:"abc"});testCM("findPosH",function(a){m([{from:b(0,0),to:b(0,1),by:1},{from:b(0,0),to:b(0,0),by:-1,hitSide:!0},{from:b(0,0),to:b(0,4),by:1,unit:"word"},{from:b(0,0),to:b(0,8),by:2,unit:"word"},{from:b(0,0),to:b(2,0),by:20,unit:"word",hitSide:!0},{from:b(0,7),to:b(0,5),by:-1,unit:"word"},{from:b(0,4),
to:b(0,8),by:1,unit:"word"},{from:b(1,0),to:b(1,18),by:3,unit:"word"},{from:b(1,22),to:b(1,5),by:-3,unit:"word"},{from:b(1,15),to:b(1,10),by:-5},{from:b(1,15),to:b(1,10),by:-5,unit:"column"},{from:b(1,15),to:b(1,0),by:-50,unit:"column",hitSide:!0},{from:b(1,15),to:b(1,24),by:50,unit:"column",hitSide:!0},{from:b(1,15),to:b(2,0),by:50,hitSide:!0}],function(b){var d=a.findPosH(b.from,b.by,b.unit||"char");eqPos(d,b.to);eq(!!d.hitSide,!!b.hitSide)})},{value:"line one\nline two.something.other\n"});testCM("beforeChange",
function(a){a.on("beforeChange",function(a,b){for(var e=[],f=0;f<b.text.length;++f)e.push(b.text[f].replace(/\s/g,"_"));b.update(null,null,e)});a.setValue("hello, i am a\nnew document\n");eq(a.getValue(),"hello,_i_am_a\nnew_document\n");CodeMirror.on(a.getDoc(),"beforeChange",function(a,b){0==b.from.line&&b.cancel()});a.setValue("oops");eq(a.getValue(),"hello,_i_am_a\nnew_document\n");a.replaceRange("hey hey hey",b(1,0),b(2,0));eq(a.getValue(),"hello,_i_am_a\nhey_hey_hey")},{value:"abcdefghijk"});
testCM("beforeChangeUndo",function(a){a.replaceRange("hi",b(0,0),b(0));a.replaceRange("bye",b(0,0),b(0));eq(a.historySize().undo,2);a.on("beforeChange",function(a,b){is(!b.update);b.cancel()});a.undo();eq(a.historySize().undo,0);eq(a.getValue(),"bye\ntwo")},{value:"one\ntwo"});testCM("beforeSelectionChange",function(a){function c(a,c){var f=a.getLine(c.line).length;return!f||c.ch==f?b(c.line,c.ch-1):c}a.on("beforeSelectionChange",function(a,b){b.update([{anchor:c(a,b.ranges[0].anchor),head:c(a,b.ranges[0].head)}])});
g(a,10,10);a.execCommand("goLineEnd");eqPos(a.getCursor(),b(0,9));a.execCommand("selectAll");eqPos(a.getCursor("start"),b(0,0));eqPos(a.getCursor("end"),b(9,9))});testCM("change_removedText",function(a){a.setValue("abc\ndef");var c=[];a.on("change",function(a,b){c.push(b.removed)});a.operation(function(){a.replaceRange("xyz",b(0,0),b(1,1));a.replaceRange("123",b(0,0))});eq(c.length,2);eq(c[0].join("\n"),"abc\nd");eq(c[1].join("\n"),"");c=[];a.undo();eq(c.length,2);eq(c[0].join("\n"),"123");eq(c[1].join("\n"),
"xyz");c=[];a.redo();eq(c.length,2);eq(c[0].join("\n"),"abc\nd");eq(c[1].join("\n"),"")});testCM("lineStyleFromMode",function(a){CodeMirror.defineMode("test_mode",function(){return{token:function(a){if(a.match(/^\[[^\]]*\]/))return"  line-brackets  ";if(a.match(/^\([^\)]*\)/))return"  line-background-parens  ";if(a.match(/^<[^>]*>/))return"  span  line-line  line-background-bg  ";a.match(/^\s+|^\S+/)}}});a.setOption("mode","test_mode");var b=k(a.getWrapperElement(),"brackets");eq(b.length,1,"brackets count");
eq(b[0].nodeName,"PRE");is(!/brackets.*brackets/.test(b[0].className));b=k(a.getWrapperElement(),"parens");eq(b.length,1,"parens count");eq(b[0].nodeName,"DIV");is(!/parens.*parens/.test(b[0].className));eq(b[0].parentElement.nodeName,"DIV");eq(k(a.getWrapperElement(),"bg").length,1);eq(k(a.getWrapperElement(),"line").length,1);a=k(a.getWrapperElement(),"cm-span");eq(a.length,2);is(/^\s*cm-span\s*$/.test(a[0].className))},{value:"line1: [br] [br]\nline2: (par) (par)\nline3: \x3ctag\x3e \x3ctag\x3e"});
testCM("lineStyleFromBlankLine",function(a){CodeMirror.defineMode("lineStyleFromBlankLine_mode",function(){return{token:function(a){a.skipToEnd();return"comment"},blankLine:function(){return"line-blank"}}});a.setOption("mode","lineStyleFromBlankLine_mode");var c=k(a.getWrapperElement(),"blank");eq(c.length,1);eq(c[0].nodeName,"PRE");a.replaceRange("x",b(1,0));c=k(a.getWrapperElement(),"blank");eq(c.length,0)},{value:"foo\n\nbar"});CodeMirror.registerHelper("xxx","a","A");CodeMirror.registerHelper("xxx",
"b","B");CodeMirror.defineMode("yyy",function(){return{token:function(a){a.skipToEnd()},xxx:["a","b","q"]}});CodeMirror.registerGlobalHelper("xxx","c",function(a){return a.enableC},"C");testCM("helpers",function(a){a.setOption("mode","yyy");eq(a.getHelpers(b(0,0),"xxx").join("/"),"A/B");a.setOption("mode",{name:"yyy",modeProps:{xxx:"b",enableC:!0}});eq(a.getHelpers(b(0,0),"xxx").join("/"),"B/C");a.setOption("mode","javascript");eq(a.getHelpers(b(0,0),"xxx").join("/"),"")});testCM("selectionHistory",
function(a){for(var c=0;3>c;c++)a.setExtending(!0),a.execCommand("goCharRight"),a.setExtending(!1),a.execCommand("goCharRight"),a.execCommand("goCharRight");a.execCommand("undoSelection");eq(a.getSelection(),"c");a.execCommand("undoSelection");eq(a.getSelection(),"");eqPos(a.getCursor(),b(0,4));a.execCommand("undoSelection");eq(a.getSelection(),"b");a.execCommand("redoSelection");eq(a.getSelection(),"");eqPos(a.getCursor(),b(0,4));a.execCommand("redoSelection");eq(a.getSelection(),"c");a.execCommand("redoSelection");
eq(a.getSelection(),"");eqPos(a.getCursor(),b(0,6))},{value:"a b c d"});testCM("selectionChangeReducesRedo",function(a){a.replaceSelection("X");a.execCommand("goCharRight");a.undoSelection();a.execCommand("selectAll");a.undoSelection();eq(a.getValue(),"Xabc");eqPos(a.getCursor(),b(0,1));a.undoSelection();eq(a.getValue(),"abc")},{value:"abc"});testCM("selectionHistoryNonOverlapping",function(a){a.setSelection(b(0,0),b(0,1));a.setSelection(b(0,2),b(0,3));a.execCommand("undoSelection");eqPos(a.getCursor("anchor"),
b(0,0));eqPos(a.getCursor("head"),b(0,1))},{value:"1234"});testCM("cursorMotionSplitsHistory",function(a){a.replaceSelection("a");a.execCommand("goCharRight");a.replaceSelection("b");a.replaceSelection("c");a.undo();eq(a.getValue(),"a1234");eqPos(a.getCursor(),b(0,2));a.undo();eq(a.getValue(),"1234");eqPos(a.getCursor(),b(0,0))},{value:"1234"});testCM("selChangeInOperationDoesNotSplit",function(a){for(var c=0;4>c;c++)a.operation(function(){a.replaceSelection("x");a.setCursor(b(0,a.getCursor().ch-
1))});eqPos(a.getCursor(),b(0,0));eq(a.getValue(),"xxxxa");a.undo();eq(a.getValue(),"a")},{value:"a"});testCM("alwaysMergeSelEventWithChangeOrigin",function(a){a.replaceSelection("U",null,"foo");a.setSelection(b(0,0),b(0,1),{origin:"foo"});a.undoSelection();eq(a.getValue(),"a");a.replaceSelection("V",null,"foo");a.setSelection(b(0,0),b(0,1),{origin:"bar"});a.undoSelection();eq(a.getValue(),"Va")},{value:"a"});testCM("getTokenTypeAt",function(a){eq(a.getTokenTypeAt(b(0,0)),"number");eq(a.getTokenTypeAt(b(0,
6)),"string");a.addOverlay({token:function(a){if(a.match("foo"))return"foo";a.next()}});eq(k(a.getWrapperElement(),"cm-foo").length,1);eq(a.getTokenTypeAt(b(0,6)),"string")},{value:"1 + 'foo'",mode:"javascript"})});
//# sourceMappingURL=test.js.map